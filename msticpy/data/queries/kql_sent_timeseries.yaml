metadata:
  version: 1
  description: TimeSeries - Series of TimeSeries queries for variety of Data Sources
  data_environments: [LogAnalytics]
  data_families: ['SigninLogs','SecurityEvent','VMConnection','CommonSecurityLog','AzureNetworkAnalytics_CL']
  tags: ['TimeSeries','host','ip','alert','PaloAlto','network']
defaults:
  parameters:
      table:
        description: Table name
        type: str
      query_project:
        description: Column project statement
        type: str
      start:
        description: Query start time
        type: datetime
      end:
        description: Query end time
        type: datetime
      timeframe:
        description: Aggregation TimeFrame
        type: str
        default: '1h'
      scorethreshold:
        description: Score threshold for alerting
        type: str
      where_clause:
        description: Optional additional filter clauses
        type: str
        default: '' 
      groupbyfield:
        description: Group by field to aggregate results
        type: str
      timestampfield:
        description: Timestamp field to use from source dataset
        type: str
        default: TimeGenerated
      aggregatefield:
        description: field to agregate from source dataset
        type: str
        default: Total
      aggregatefunction:
        description: Aggregation functions to use - count(), sum(), avg() etc
        type: str
        default: count()
sources:
  get_timeseries_data:
    description: Retrieves TimeSeriesData prepared to use with built-in KQL time series functions
    args:
      query: '
            {table}
            {query_project}
            {where_clause}
            | where {timestampfield} between (datetime({start})...datetime({end}))
            | make-series {aggregatefield}={aggregatefunction} on {timestampfield} from datetime({start}) to datetime({end}) step {timeframe} by {groupbyfield}
            '
  get_timeseries_alerts:
    description: Time Series anomaly alerts generated using built-in KQL time series functions
    args:
      query: '
            {table}
            {query_project}
            {where_clause}
            | where {timestampfield} between (datetime({start})...datetime({end}))
            | make-series {aggregatefield}={aggregatefunction} on {timestampfield} from datetime({start}) to datetime({end}) step {timeframe} by {groupbyfield}
            | extend (anomalies, score, baseline) = series_decompose_anomalies({aggregatefield}, {scorethreshold},-1,"linefit")
            | mv-expand {aggregatefield} to typeof(double), {timestampfield} to typeof(datetime), anomalies to typeof(double), score to typeof(double), baseline to typeof(long) 
            | where anomalies > 0 | extend score = round(score,2)
            '
  plot_timeseries_datawithbaseline:
    description: Plot timeseries data using built-in KQL time series decomposition using built-in KQL render method
    args:
      query: '
            {table}
            {query_project}
            {where_clause} 
            | where {timestampfield} between (datetime({start})...datetime({end}))
            | make-series {aggregatefield}={aggregatefunction} on {timestampfield} from datetime({start}) to datetime({end}) step {timeframe} by {groupbyfield}
            | extend (baseline,seasonal,trend,residual) = series_decompose({aggregatefield}) 
            | project {timestampfield}, {aggregatefield}, baseline
            | render timechart with (Title="Time Series Decomposition with Baseline vs Actual Chart")
            '
  plot_timeseries_scoreanomolies:
    description: Plot timeseries anomaly score using built-in KQL render method
    args:
      query: '
            {table}
            {query_project}
            {where_clause} 
            | where {timestampfield} between (datetime({start})...datetime({end}))
            | make-series {aggregatefield}={aggregatefunction} on {timestampfield} from datetime({start}) to datetime({end}) step {timeframe} by {groupbyfield}
            | extend (anomalies, score, baseline) = series_decompose_anomalies({aggregatefield}, {scorethreshold},-1,"linefit")
            {mvexpand_clause}
            | project {timestampfield}, score
            | render timechart with (Title="Time Series Anomalies Chart")
            '